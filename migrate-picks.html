<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picks Migration Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .status.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .status.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .status.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .instructions {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #0056b3;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Picks Migration Tool</h1>
        
        <div class="instructions">
            <h3>How to Use This Tool:</h3>
            <ol>
                <li><strong>Open Firebase Console</strong> - Go to your Firebase project</li>
                <li><strong>Navigate to Firestore Database</strong> - Go to the Database section</li>
                <li><strong>Open Console</strong> - Press F12 to open developer tools, go to Console tab</li>
                <li><strong>Copy Migration Script</strong> - Copy the content of <code>migrate-picks.js</code></li>
                <li><strong>Paste & Run</strong> - Paste the script in the Firebase console and press Enter</li>
                <li><strong>Run Migration</strong> - Type <code>migratePicksToCollection()</code> and press Enter</li>
            </ol>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="showMigrationScript()">üìã Show Migration Script</button>
            <button class="btn-success" onclick="showInstructions()">üìñ Show Instructions</button>
            <button class="btn-warning" onclick="showSampleData()">üîç Show Sample Data Structure</button>
        </div>

        <div id="status" class="status">
            <strong>Status:</strong> Ready to migrate picks data from users collection to new picks collection
        </div>

        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        function showMigrationScript() {
            const log = document.getElementById('log');
            log.style.display = 'block';
            log.textContent = `// Copy this script and paste it in Firebase Console

// Standalone Picks Migration Script
async function migratePicksToCollection() {
    console.log('üöÄ Starting picks migration...');
    
    try {
        // Get all users
        const usersSnapshot = await db.collection('users').get();
        console.log('üîç Found users:', usersSnapshot.size);
        
        let totalPicksMigrated = 0;
        let usersProcessed = 0;
        let errors = [];
        
        // Process each user
        for (const userDoc of usersSnapshot.docs) {
            const userData = userDoc.data();
            usersProcessed++;
            
            if (!userData.picks || Object.keys(userData.picks).length === 0) {
                console.log(\`‚è≠Ô∏è Skipping user \${userData.firstName} \${userData.surname} - no picks\`);
                continue;
            }
            
            console.log(\`üîç Processing user \${usersProcessed}/\${usersSnapshot.size}: \${userData.firstName} \${userData.surname}\`);
            
            // Process each pick
            for (const [pickKey, teamPicked] of Object.entries(userData.picks)) {
                if (!teamPicked || teamPicked === 'No Pick Made') {
                    console.log(\`‚è≠Ô∏è Skipping invalid pick: \${pickKey} = \${teamPicked}\`);
                    continue;
                }
                
                try {
                    // Parse pick key to extract edition and gameweek
                    let edition, gameweek, gameweekKey;
                    
                    if (pickKey.startsWith('editiontest_')) {
                        edition = 'test';
                        gameweekKey = pickKey.replace('editiontest_', '');
                    } else if (pickKey.startsWith('edition') && pickKey.includes('_')) {
                        const parts = pickKey.split('_');
                        edition = parts[0].replace('edition', '');
                        gameweekKey = parts[1];
                    } else if (pickKey.startsWith('gw')) {
                        edition = 'test'; // Default to test for simple gw keys
                        gameweekKey = pickKey;
                    } else {
                        console.log(\`‚ö†Ô∏è Unknown pick key format: \${pickKey}\`);
                        continue;
                    }
                    
                    // Extract gameweek number
                    if (gameweekKey === 'gwtiebreak') {
                        gameweek = 'tiebreak';
                    } else if (gameweekKey.startsWith('gw')) {
                        gameweek = gameweekKey.replace('gw', '');
                    } else {
                        console.log(\`‚ö†Ô∏è Unknown gameweek format: \${gameweekKey}\`);
                        continue;
                    }
                    
                    // Create pick document
                    const pickData = {
                        userId: userDoc.id,
                        userFirstName: userData.firstName || '',
                        userSurname: userData.surname || '',
                        displayName: userData.displayName || '',
                        edition: edition,
                        gameweek: gameweek,
                        gameweekKey: gameweekKey,
                        teamPicked: teamPicked,
                        timestamp: new Date(),
                        isActive: true,
                        originalPickKey: pickKey,
                        migratedAt: new Date(),
                        migrationSource: 'users_collection'
                    };
                    
                    // Add to picks collection
                    await db.collection('picks').add(pickData);
                    totalPicksMigrated++;
                    
                    console.log(\`‚úÖ Migrated pick: \${userData.firstName} \${userData.surname} - \${edition} \${gameweek} -> \${teamPicked}\`);
                    
                } catch (pickError) {
                    console.error(\`‚ùå Error migrating pick \${pickKey} for user \${userData.firstName} \${userData.surname}:\`, pickError);
                    errors.push({
                        userId: userDoc.id,
                        userName: \`\${userData.firstName} \${userData.surname}\`,
                        pickKey: pickKey,
                        error: pickError.message
                    });
                }
            }
        }
        
        console.log('üéâ Migration completed!');
        console.log(\`üìä Total picks migrated: \${totalPicksMigrated}\`);
        console.log(\`üë• Users processed: \${usersProcessed}\`);
        
        if (errors.length > 0) {
            console.log(\`‚ö†Ô∏è Errors encountered: \${errors.length}\`);
            console.log('Error details:', errors);
        }
        
        return {
            success: true,
            totalPicksMigrated,
            usersProcessed,
            errors
        };
        
    } catch (error) {
        console.error('‚ùå Migration failed:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// After pasting, run: migratePicksToCollection()`;
        }

        function showInstructions() {
            const log = document.getElementById('log');
            log.style.display = 'block';
            log.textContent = `üìñ STEP-BY-STEP MIGRATION INSTRUCTIONS

1. üî• OPEN FIREBASE CONSOLE
   - Go to https://console.firebase.google.com/
   - Select your LOS App project
   - Navigate to Firestore Database

2. üì± OPEN DEVELOPER CONSOLE
   - Press F12 (or right-click ‚Üí Inspect)
   - Click on "Console" tab
   - Make sure you're in the Firebase console context

3. üìã PASTE MIGRATION SCRIPT
   - Copy the migration script from the "Show Migration Script" button
   - Paste it into the Firebase console
   - Press Enter to load the script

4. üöÄ RUN MIGRATION
   - Type: migratePicksToCollection()
   - Press Enter to start the migration
   - Watch the console for progress updates

5. ‚úÖ VERIFY RESULTS
   - Check the new 'picks' collection in Firestore
   - Verify all picks were migrated correctly
   - Check the console for migration summary

6. üßπ CLEANUP (Optional)
   - Run: cleanupMigration() to remove migration metadata
   - This step is optional and can be done later

‚ö†Ô∏è  IMPORTANT NOTES:
- The migration is safe and won't delete original data
- All picks will be preserved in the new collection
- You can run the migration multiple times safely
- The script handles errors gracefully and continues processing

üéØ EXPECTED OUTCOME:
- New 'picks' collection with clean, structured data
- Each pick as a separate document
- Easy to query and manage
- Better performance for the admin panel`;
        }

        function showSampleData() {
            const log = document.getElementById('log');
            log.style.display = 'block';
            log.textContent = `üîç SAMPLE DATA STRUCTURE

üìä CURRENT STRUCTURE (in users collection):
{
  "users": {
    "user123": {
      "firstName": "James",
      "surname": "Buchan",
      "picks": {
        "editiontest_gw1": "Altrincham",
        "editiontest_gw2": "Boreham Wood",
        "gw3": "Carlisle United"
      }
    }
  }
}

üÜï NEW STRUCTURE (in picks collection):
{
  "picks": {
    "pick123": {
      "userId": "user123",
      "userFirstName": "James",
      "userSurname": "Buchan",
      "edition": "test",
      "gameweek": "1",
      "gameweekKey": "gw1",
      "teamPicked": "Altrincham",
      "timestamp": "2024-01-15T10:30:00Z",
      "isActive": true,
      "originalPickKey": "editiontest_gw1"
    },
    "pick124": {
      "userId": "user123",
      "userFirstName": "James",
      "userSurname": "Buchan",
      "edition": "test",
      "gameweek": "2",
      "gameweekKey": "gw2",
      "teamPicked": "Boreham Wood",
      "timestamp": "2024-01-15T10:30:00Z",
      "isActive": true,
      "originalPickKey": "editiontest_gw2"
    }
  }
}

‚úÖ BENEFITS OF NEW STRUCTURE:
- Clean, normalized data
- Easy to query by edition, gameweek, or user
- Better performance for large datasets
- Easier to maintain and extend
- Better for analytics and reporting
- No more nested object complexity

üîç QUERY EXAMPLES:
- All picks for GW1: where gameweek == "1"
- All picks for test edition: where edition == "test"
- User's picks: where userId == "user123"
- Active picks: where isActive == true`;
        }

        // Update status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>Status:</strong> Ready to migrate picks data. Use the buttons above to get started.';
        });
    </script>
</body>
</html>
