<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Last One Standing</title>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* Edition selector responsive display */
        @media (max-width: 767px) {
            .desktop-edition-selector {
                display: none !important;
            }
            .mobile-edition-selector {
                display: block !important;
            }
        }
        @media (min-width: 768px) {
            .desktop-edition-selector {
                display: block !important;
            }
            .mobile-edition-selector {
                display: none !important;
            }
        }
        
        /* iPad-specific adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            /* Ensure desktop layout shows on iPads */
            .desktop-layout {
                display: block !important;
            }
            .mobile-tabs {
                display: none !important;
            }
            .mobile-tab-content {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <header>
        <img src="../assets/images/Logo Round1.png" alt="Altrincham FC Crest" class="header-crest">
        <div class="header-text">
            <h1>Altrincham FC Juniors<br>Last One Standing</h1>
            <h2>The Ultimate National League Challenge</h2>
        </div>
        <img src="../assets/images/Logo Round1.png" alt="Altrincham FC Crest" class="header-crest">
    </header>

    <div class="container">
        <!-- Mobile Tab Navigation -->
        <div class="mobile-tabs">
            <button class="tab-btn active" data-tab="fixtures">
                <span class="tab-icon" style="filter: grayscale(100%);">⚽</span>
                <span class="tab-label">Fixtures</span>
            </button>
            <button class="tab-btn" data-tab="picks">
                <span class="tab-icon">📋</span>
                <span class="tab-label">My Picks</span>
            </button>
            <button class="tab-btn" data-tab="as-it-stands">
                <span class="tab-icon">🏆</span>
                <span class="tab-label">As It Stands</span>
            </button>
            <button class="tab-btn" data-tab="scores">
                <span class="tab-icon">📊</span>
                <span class="tab-label">Scores</span>
            </button>
            <button class="tab-btn" data-tab="vidiprinter">
                <span class="tab-icon">📺</span>
                <span class="tab-label">Live</span>
            </button>
        </div>

        <!-- Desktop Layout -->
        <div class="desktop-layout">
            <!-- Desktop Tab Navigation -->
            <div class="desktop-tabs">
                <button class="desktop-tab-btn active" data-tab="fixtures">
                    <span class="desktop-tab-icon" style="filter: grayscale(100%);">⚽</span>
                    <span class="desktop-tab-label">Fixtures</span>
                </button>
                <button class="desktop-tab-btn" data-tab="picks">
                    <span class="desktop-tab-icon">📋</span>
                    <span class="desktop-tab-label">My Picks</span>
                </button>
                <button class="desktop-tab-btn" data-tab="as-it-stands">
                    <span class="desktop-tab-icon">🏆</span>
                    <span class="desktop-tab-label">As It Stands</span>
                </button>
                <button class="desktop-tab-btn" data-tab="scores">
                    <span class="desktop-tab-icon">📊</span>
                    <span class="desktop-tab-label">Scores</span>
                </button>
                <button class="desktop-tab-btn" data-tab="vidiprinter">
                    <span class="desktop-tab-icon">📺</span>
                    <span class="desktop-tab-label">Live Updates</span>
                </button>
            </div>

            <!-- Desktop Tab Content -->
            <div class="desktop-tab-content">
                <!-- Fixtures Tab -->
                <div id="desktop-fixtures-tab" class="desktop-tab-pane active">
                    <div class="desktop-intro">
                        <h2 id="welcome-message">Welcome Player</h2>
                        <p>Make your picks for each game week below. You can make picks in advance and edit any pick up until that week's deadline.</p>
                        
                        <!-- Edition Selection (only shown if user is registered for multiple editions) -->
                        <!-- This is now handled by EditionService in the edition-selector-container below -->
                        
                        <!-- Edition Selector Container for EditionService -->
                        <div id="edition-selector-container" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 8px; border: 1px solid #28a745;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #155724;">Active Edition:</h4>
                            <!-- EditionService will populate this -->
                        </div>
                        
                        <!-- Game Week Navigation -->
                        <div id="gameweek-navigation" class="gameweek-nav" style="display: none;">
                            <h3>Game Week Navigation</h3>
                            <div class="nav-controls">
                                <button id="prev-gameweek" class="nav-button">← Previous</button>
                                <span id="current-gameweek-display" class="current-gameweek">Game Week 1</span>
                                <button id="next-gameweek" class="nav-button">Next →</button>
                            </div>
                            <div class="gameweek-tabs">
                                <button class="gameweek-tab active" data-gameweek="1">GW 1</button>
                                <button class="gameweek-tab" data-gameweek="2">GW 2</button>
                                <button class="gameweek-tab" data-gameweek="3">GW 3</button>
                                <button class="gameweek-tab" data-gameweek="4">GW 4</button>
                                <button class="gameweek-tab" data-gameweek="5">GW 5</button>
                                <button class="gameweek-tab" data-gameweek="6">GW 6</button>
                                <button class="gameweek-tab" data-gameweek="7">GW 7</button>
                                <button class="gameweek-tab" data-gameweek="8">GW 8</button>
                                <button class="gameweek-tab" data-gameweek="9">GW 9</button>
                                <button class="gameweek-tab" data-gameweek="10">GW 10</button>
                                <button class="gameweek-tab tiebreak-tab" data-gameweek="tiebreak" style="display: none;">Tiebreak</button>
                            </div>
                        </div>
                        
                        <!-- Combined Fixtures and Deadline Section -->
                        <div id="fixtures-display-container" class="fixtures-section" style="display: none;">
                            <div class="deadline-section">
                                <div class="deadline-header">
                                    <h3><strong>Game Week Deadline - <span class="deadline-date" id="deadline-date" style="color: #dc3545;">--</span></strong></h3>
                                </div>
                                <p class="deadline-status"><strong>Game Week Status:</strong> <span id="deadline-status" style="color: inherit;">--</span></p>
                                <div class="pick-status-header">
                                    <span id="pick-status-display" class="pick-status-text">--</span>
                                </div>
                            </div>
                            <div id="fixtures-display">
                                <p>Loading fixtures...</p>
                            </div>
                        </div>
                        
                        <script>
                        // Debug script to track deadline changes
                        document.addEventListener('DOMContentLoaded', function() {
                            const deadlineElement = document.getElementById('deadline-date');
                            if (deadlineElement) {
                                console.log('🔍 Setting up deadline change observer');
                                
                                // Create a MutationObserver to watch for changes
                                const observer = new MutationObserver(function(mutations) {
                                    mutations.forEach(function(mutation) {
                                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                                            console.log('🔍 Deadline element changed!');
                                            console.log('🔍 New value:', deadlineElement.textContent);
                                            console.log('🔍 Mutation type:', mutation.type);
                                            console.log('🔍 Mutation target:', mutation.target);
                                        }
                                    });
                                });
                                
                                // Start observing
                                observer.observe(deadlineElement, {
                                    childList: true,
                                    characterData: true,
                                    subtree: true
                                });
                                
                                console.log('🔍 Deadline observer started');
                            }
                        });
                        </script>
                    </div>
                </div>

                <!-- Picks Tab -->
                <div id="desktop-picks-tab" class="desktop-tab-pane">
                    <div class="desktop-picks-section">
                        <h2>Player Status & Picks</h2>
                        <div class="picks-content">
                            <div class="player-status-card">
                                <h3>Player Status</h3>
                                <p><span id="desktop-lives-remaining">--</span></p>
                            </div>
                            <div class="picks-history-card">
                                <h3>Your Picks</h3>
                                <div id="desktop-picks-history">
                                    <p>No picks made yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- As It Stands Tab -->
                <div id="desktop-as-it-stands-tab" class="desktop-tab-pane">
                    <div class="desktop-as-it-stands-section">
                        <h2>As It Stands</h2>
                        <div class="as-it-stands-content">
                            <div class="gameweek-selector">
                                <label for="desktop-as-it-stands-gameweek">Select Game Week:</label>
                                <select id="desktop-as-it-stands-gameweek">
                                    <option value="">Loading game weeks...</option>
                                </select>
                            </div>
                            <div id="desktop-as-it-stands-display">
                                <p>Select a game week to view the current standings.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scores Tab -->
                <div id="desktop-scores-tab" class="desktop-tab-pane">
                    <div class="desktop-scores-section">
                        <h2>Live Scores & Results</h2>
                        <div id="desktop-scores-display">
                            <p>Scores will appear here when available.</p>
                        </div>
                    </div>
                </div>

                <!-- Vidiprinter Tab -->
                <div id="desktop-vidiprinter-tab" class="desktop-tab-pane">
                    <div class="desktop-vidiprinter-section">
                        <h2>Live Match Updates</h2>
                        <div id="desktop-vidiprinter-display">
                            <p>Live updates will appear here during matches.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="user-logged-in-view" style="display: none; margin-top: 30px;">
                <button id="logout-button" class="secondary-button">Logout</button>
            </div>
        </div>

        <!-- Mobile Tab Content -->
        <div class="mobile-tab-content">
            <!-- Fixtures Tab -->
            <div id="fixtures-tab" class="tab-pane active">
                <div class="mobile-intro">
                    <h2 id="mobile-welcome-message">Welcome Player</h2>
                    <p>Make your picks for each game week below. You can make picks in advance and edit any pick up until that week's deadline.</p>
                    
                    <!-- Mobile Edition Selection (only shown if user is registered for multiple editions) -->
                    <!-- This is now handled by EditionService in the edition-selector-container below -->
                    
                    <!-- Mobile Edition Selector Container for EditionService -->
                    <div id="mobile-edition-selector-container" style="margin-bottom: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 8px; border: 1px solid #28a745;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #155724;">Active Edition:</h4>
                        <!-- EditionService will populate this -->
                    </div>
                </div>
                
                <!-- Mobile Game Week Navigation -->
                <div id="mobile-gameweek-navigation" class="mobile-gameweek-nav">
                    <div class="mobile-nav-controls">
                        <button id="mobile-prev-gameweek" class="nav-button">←</button>
                        <span id="mobile-current-gameweek-display" class="current-gameweek">Game Week 1</span>
                        <button id="mobile-next-gameweek" class="nav-button">→</button>
                    </div>
                    <div class="mobile-gameweek-tabs">
                        <button class="gameweek-tab active" data-gameweek="1">GW 1</button>
                        <button class="gameweek-tab" data-gameweek="2">GW 2</button>
                        <button class="gameweek-tab" data-gameweek="3">GW 3</button>
                        <button class="gameweek-tab" data-gameweek="4">GW 4</button>
                        <button class="gameweek-tab" data-gameweek="5">GW 5</button>
                        <button class="gameweek-tab" data-gameweek="6">GW 6</button>
                        <button class="gameweek-tab" data-gameweek="7">GW 7</button>
                        <button class="gameweek-tab" data-gameweek="8">GW 8</button>
                        <button class="gameweek-tab" data-gameweek="9">GW 9</button>
                        <button class="gameweek-tab" data-gameweek="10">GW 10</button>
                        <button class="gameweek-tab tiebreak-tab" data-gameweek="tiebreak" style="display: none;">Tiebreak</button>
                    </div>
                </div>
                
                <!-- Mobile Fixtures Display -->
                <div id="mobile-fixtures-display-container" class="mobile-fixtures-section">
                    <div class="mobile-deadline-section">
                        <h3><strong>Game Week Deadline - <span class="deadline-date" id="mobile-deadline-date" style="color: #dc3545;">--</span></strong></h3>
                        <p class="deadline-status"><strong>Game Week Status:</strong> <span id="mobile-deadline-status" style="color: inherit;">--</span></p>
                        <div class="pick-status-header">
                            <span id="mobile-pick-status-display" class="pick-status-text">--</span>
                        </div>
                    </div>
                    
                    <div id="mobile-fixtures-display">
                        <p>Loading fixtures...</p>
                    </div>
                    
                    <script>
                    // Debug script to track mobile deadline changes
                    document.addEventListener('DOMContentLoaded', function() {
                        const mobileDeadlineElement = document.getElementById('mobile-deadline-date');
                        if (mobileDeadlineElement) {
                            console.log('🔍 Setting up mobile deadline change observer');
                            
                            // Create a MutationObserver to watch for changes
                            const observer = new MutationObserver(function(mutations) {
                                mutations.forEach(function(mutation) {
                                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                                        console.log('🔍 Mobile deadline element changed!');
                                        console.log('🔍 New value:', mobileDeadlineElement.textContent);
                                        console.log('🔍 Mutation type:', mutation.type);
                                        console.log('🔍 Mutation target:', mutation.target);
                                    }
                                });
                            });
                            
                            // Start observing
                            observer.observe(mobileDeadlineElement, {
                                childList: true,
                                characterData: true,
                                subtree: true
                            });
                            
                            console.log('🔍 Mobile deadline observer started');
                        }
                    });
                    </script>
                </div>
            </div>

            <!-- Picks Tab -->
            <div id="picks-tab" class="tab-pane">
                <div class="mobile-picks-section">
                    <h3>Player Status</h3>
                    <p><span id="mobile-lives-remaining">--</span></p>
                    <hr>
                    <h3>Your Picks</h3>
                    <div id="mobile-picks-history">
                        <p>No picks made yet.</p>
                    </div>
                </div>
            </div>

            <!-- As It Stands Tab -->
            <div id="as-it-stands-tab" class="tab-pane">
                <div class="mobile-as-it-stands-section">
                    <h3>As It Stands</h3>
                    <div class="mobile-as-it-stands-content">
                        <div class="mobile-gameweek-selector">
                            <label for="mobile-as-it-stands-gameweek">Select Game Week:</label>
                            <select id="mobile-as-it-stands-gameweek">
                                <option value="">Loading game weeks...</option>
                            </select>
                        </div>
                        <div id="mobile-as-it-stands-display">
                            <p>Select a game week to view the current standings.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scores Tab -->
            <div id="scores-tab" class="tab-pane">
                <div class="mobile-scores-section">
                    <h3>Live Scores & Results</h3>
                    <div id="mobile-scores-display">
                        <p>Scores will appear here when available.</p>
                    </div>
                </div>
            </div>

            <!-- Vidiprinter Tab -->
            <div id="vidiprinter-tab" class="tab-pane">
                <div class="mobile-vidiprinter-section">
                    <h3>Live Match Updates</h3>
                    <div id="mobile-vidiprinter-display">
                        <p>Live updates will appear here during matches.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p><a href="https://altrinchamfc.com/pages/altyforall%C2%AE" target="_blank">ALTY for ALL</a></p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/config/firebase-init.js"></script>
    <script src="/config/env-config.js"></script>
    <script src="/config/netlify-env.js"></script>
    <script src="/config/teams-config.js"></script>
    <script src="/config/football-webpages-config.js"></script>
    
    <!-- Team Pick Button Styles -->
    <style>
        .team-pick-button {
            padding: 8px 16px;
            margin: 4px;
            border: 2px solid #007bff;
            border-radius: 6px;
            background: white;
            color: #007bff;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .team-pick-button:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .team-pick-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 123, 255, 0.3);
        }
        
        .team-pick-button.selected,
        .team-pick-button.current-pick {
            background: #28a745;
            border-color: #28a745;
            color: white;
            cursor: default;
        }
        
        .team-pick-button.future-pick {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .team-pick-button.locked-pick {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
            cursor: not-allowed;
            opacity: 0.8;
            position: relative;
        }
        
        .team-pick-button.locked-pick::after {
            content: "🔒";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 12px;
            background: #dc3545;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .team-pick-button.available {
            background: white;
            border-color: #007bff;
            color: #007bff;
        }
        
        .team-pick-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .pick-indicator {
            margin-left: 8px;
            color: #28a745;
            font-weight: bold;
        }
        
        .fixture-teams {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 12px 0;
        }
        
        .vs {
            font-weight: bold;
            color: #6c757d;
            margin: 0 8px;
        }
        
        .fixture-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background: white;
        }
        
        .fixture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .fixture-date {
            font-weight: 500;
            color: #495057;
        }
        
        .fixture-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .fixture-status.completed {
            background: #d4edda;
            color: #155724;
        }
        
        .fixture-status.in-progress {
            background: #fff3cd;
            color: #856404;
        }
        
        .fixture-status.not-started {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .fixture-score {
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #495057;
            margin-top: 8px;
        }
    </style>
    
    <!-- Source modules -->
    <script type="module" src="../app.bundle.js"></script>
    
    <!-- Dashboard initialization script -->
    <script>
        // Wait for the app to be fully initialized
        let retryCount = 0;
        const maxRetries = 30; // 30 seconds timeout
        
        function waitForApp() {
            console.log('🔧 Dashboard: Checking for app initialization...');
            console.log('🔧 Dashboard: editionService available:', !!window.editionService);
            console.log('🔧 Dashboard: authManager available:', !!window.authManager);
            
            // Update loading message
            updateLoadingMessage('Checking app services...');
            
            // Check timeout
            if (retryCount >= maxRetries) {
                updateLoadingMessage('App initialization timeout. Please refresh the page.');
                console.error('❌ Dashboard: App initialization timeout after', maxRetries, 'seconds');
                return;
            }
            
            retryCount++;
            
            // Check if we need to wait longer for app initialization
            if (!window.authManager || !window.editionService) {
                updateLoadingMessage(`App services not ready, waiting... (${retryCount}/${maxRetries})`);
                setTimeout(waitForApp, 1000);
                return;
            }
            
            if (window.editionService && window.authManager) {
                console.log('🔧 Dashboard: App initialized, setting up edition selector');
                setupDashboard();
            } else {
                console.log('🔧 Dashboard: Waiting for app to initialize...');
                setTimeout(waitForApp, 100);
            }
        }
        
        function setupDashboard() {
            console.log('🔧 Dashboard: Setting up dashboard...');
            
            // Check if user is authenticated
            console.log('🔧 Dashboard: Auth check - firebaseUser:', window.authManager?.currentUser?.email);
            console.log('🔧 Dashboard: Auth check - authManagerUser:', window.authManager?.currentUser?.email);
            console.log('🔧 Dashboard: Auth check - isAuthenticated:', !!(window.authManager && window.authManager.currentUser));
            console.log('🔧 Dashboard: Auth check - auth object available:', !!window.authManager?.auth);
            
            if (window.authManager && window.authManager.currentUser) {
                const user = window.authManager.currentUser;
                console.log('🔧 Dashboard: User authenticated, setting up edition selector for:', user.email);
                console.log('🔧 Dashboard: User UID:', user.uid);
                
                // Test alert to see if user is authenticated
                alert('User authenticated! User: ' + user.email);
                
                // Get user data and create edition selector
                window.authManager.db.collection('users').doc(user.uid).get().then(userDoc => {
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        console.log('🔧 Dashboard: User data loaded:', userData);
                        console.log('🔧 Dashboard: User registrations:', userData.registrations);
                        
                        // Create edition selector using EditionService
                        if (window.editionService) {
                            console.log('🔧 Dashboard: Creating edition selector...');
                            
                            // Initialize the EditionService with user data first
                            window.editionService.initializeWithUser(userData, user.uid).then(() => {
                                console.log('🔧 Dashboard: EditionService initialized, creating selectors...');
                                
                                // Create edition selector for desktop
                                window.editionService.createEditionSelector(userData, user.uid, '#edition-selector-container').catch(error => {
                                    console.error('❌ Dashboard: Error creating desktop edition selector:', error);
                                });
                                
                                // Enhanced mobile detection for OnePlus and similar devices
                                const userAgent = navigator.userAgent.toLowerCase();
                                const isMobileDevice = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
                                const isOnePlus = userAgent.includes('oneplus') || userAgent.includes('one plus') || userAgent.includes('oneplus12') || userAgent.includes('one plus 12');
                                const isHighResMobile = window.innerWidth <= 1440 && isMobileDevice;
                                
                                // Additional OnePlus detection methods
                                const isOnePlusByScreen = window.innerWidth >= 1440 && window.innerHeight >= 3000; // OnePlus 12 dimensions
                                const isOnePlusByPlatform = navigator.platform && navigator.platform.toLowerCase().includes('android');
                                const isOnePlusByVendor = navigator.vendor && navigator.vendor.toLowerCase().includes('google');
                                
                                // Combined OnePlus detection
                                const isOnePlusDevice = isOnePlus || isOnePlusByScreen || (isOnePlusByPlatform && isOnePlusByVendor && window.innerWidth >= 1440);
                                
                                console.log('🔧 Dashboard: Device detection:', {
                                    userAgent: userAgent.substring(0, 100) + '...',
                                    isMobileDevice,
                                    isOnePlus,
                                    isOnePlusByScreen,
                                    isOnePlusByPlatform,
                                    isOnePlusByVendor,
                                    isOnePlusDevice,
                                    isHighResMobile,
                                    windowWidth: window.innerWidth,
                                    windowHeight: window.innerHeight,
                                    platform: navigator.platform,
                                    vendor: navigator.vendor
                                });
                                
                                // Update loading message for device detection
                                updateLoadingMessage('Detecting device type...');
                                
                                // Log device detection (console only, no alerts)
                                console.log('🔧 Dashboard: Device detection:', {
                                    userAgent: userAgent.substring(0, 100) + '...',
                                    isMobileDevice,
                                    isOnePlus,
                                    isOnePlusByScreen,
                                    isOnePlusByPlatform,
                                    isOnePlusByVendor,
                                    isOnePlusDevice,
                                    isHighResMobile,
                                    windowWidth: window.innerWidth,
                                    windowHeight: window.innerHeight,
                                    platform: navigator.platform,
                                    vendor: navigator.vendor
                                });
                                
                                // Update loading message for edition selector creation
                                updateLoadingMessage('Creating edition selectors...');
                                
                                // Create edition selector for mobile
                                window.editionService.createEditionSelector(userData, user.uid, '#mobile-edition-selector-container').then(() => {
                                    console.log('✅ Mobile edition selector created successfully');
                                    updateLoadingMessage('Mobile edition selector created successfully!');
                                }).catch(error => {
                                    console.error('❌ Dashboard: Error creating mobile edition selector:', error);
                                    updateLoadingMessage('Error creating mobile edition selector: ' + error.message);
                                });
                                
                                // Force mobile layout for OnePlus and similar devices
                                if (isOnePlusDevice || isHighResMobile) {
                                    console.log('🔧 Dashboard: Detected OnePlus or high-res mobile device, forcing mobile layout');
                                    document.body.classList.add('force-mobile-layout');
                                    
                                    // Ensure mobile elements are visible
                                    const mobileElements = [
                                        '#mobile-edition-selector-container',
                                        '#mobile-gameweek-navigation',
                                        '#mobile-fixtures-display-container'
                                    ];
                                    
                                    mobileElements.forEach(selector => {
                                        const element = document.querySelector(selector);
                                        if (element) {
                                            element.style.display = 'block';
                                            element.style.visibility = 'visible';
                                            element.style.opacity = '1';
                                        }
                                    });
                                }
                                
                                // Load fixtures for the current gameweek after edition selector is set up
                                if (window.loadFixturesForDeadline) {
                                    console.log('🔧 Dashboard: Loading fixtures after edition selector setup...');
                                    const currentGameweek = '1'; // Default to gameweek 1
                                    window.loadFixturesForDeadline(currentGameweek, userData, user.uid);
                                }
                                
                                // Load mobile fixtures for the current gameweek after edition selector is set up
                                if (window.loadMobileFixturesForDeadline) {
                                    console.log('🔧 Dashboard: Loading mobile fixtures after edition selector setup...');
                                    const currentGameweek = '1'; // Default to gameweek 1
                                    window.loadMobileFixturesForDeadline(currentGameweek, userData, user.uid);
                                }
                                
                                // Hide loading indicator on success
                                setTimeout(() => {
                                    hideLoadingIndicator();
                                    console.log('✅ Dashboard: Setup complete, loading indicator hidden');
                                }, 1000);
                            }).catch(error => {
                                console.error('❌ Dashboard: Error initializing EditionService:', error);
                                updateLoadingMessage('Error: ' + error.message);
                            });
                        } else {
                            console.error('❌ Dashboard: EditionService not available');
                        }
                    } else {
                        console.log('🔧 Dashboard: User document does not exist');
                    }
                }).catch(error => {
                    console.error('🔧 Dashboard: Error loading user data:', error);
                });
            } else {
                console.log('🔧 Dashboard: No authenticated user found');
                console.log('🔧 Dashboard: authManager:', window.authManager);
                if (window.authManager) {
                    console.log('🔧 Dashboard: authManager.currentUser:', window.authManager.currentUser);
                }
                
                // Show authentication status in loading message
                updateLoadingMessage('Waiting for user authentication...');
            }
        }
        
        // Loading indicator functions
        function showLoadingIndicator(message) {
            // Remove existing loading indicator
            hideLoadingIndicator();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; max-width: 300px;">
                        <div style="margin-bottom: 1rem;">
                            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Loading...</div>
                        <div style="font-size: 0.9rem; color: #666;">${message}</div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
        }
        
        function hideLoadingIndicator() {
            const existing = document.getElementById('loading-indicator');
            if (existing) {
                existing.remove();
            }
        }
        
        function updateLoadingMessage(message) {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                const messageDiv = loadingDiv.querySelector('div:last-child');
                if (messageDiv) {
                    messageDiv.textContent = message;
                }
            }
        }
        
        // Start waiting for app initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Dashboard: DOM loaded, waiting for app initialization...');
            
            // Show loading indicator instead of alert
            showLoadingIndicator('Initializing app...');
            
            waitForApp();
            
            // Add mobile tab switching functionality
            const mobileTabButtons = document.querySelectorAll('.mobile-tabs .tab-btn');
            const mobileTabPanes = document.querySelectorAll('.mobile-tab-content .tab-pane');
            
            console.log('🔧 Dashboard: Mobile tab buttons found:', mobileTabButtons.length);
            console.log('🔧 Dashboard: Mobile tab panes found:', mobileTabPanes.length);
            
            mobileTabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    console.log('🔧 Dashboard: Mobile tab clicked:', targetTab);
                    
                    // Remove active class from all buttons and panes
                    mobileTabButtons.forEach(btn => btn.classList.remove('active'));
                    mobileTabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    this.classList.add('active');
                    const targetPane = document.getElementById(targetTab + '-tab');
                    if (targetPane) {
                        targetPane.classList.add('active');
                        console.log('🔧 Dashboard: Mobile tab pane activated:', targetTab + '-tab');
                    } else {
                        console.error('🔧 Dashboard: Mobile tab pane not found:', targetTab + '-tab');
                    }
                });
            });
        });
    </script>
    
    <!-- Using bundled app.bundle.js for local testing -->

</body>
</html>
